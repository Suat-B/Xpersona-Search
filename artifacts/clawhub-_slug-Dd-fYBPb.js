import{c as O,u as c,a,b as j,m as U,r as l,j as s,i as $,w as M}from"./main-C9BDiSjk.js";import{S as A}from"./SoulStats-DOGtLLsF.js";import{s as B}from"./skillDetailUtils-OCVV1cKa.js";import{M as P,r as V}from"./index-CEpfy9K4.js";function z({slug:d}){const{isAuthenticated:i,me:m}=O(),n=c(a.souls.getBySlug,{slug:d}),_=j(a.soulStars.toggle),I=j(a.soulComments.add),R=j(a.soulComments.remove),N=U(a.souls.getReadme),p=U(a.seed.ensureSoulSeeds),S=l.useRef(!1),[u,h]=l.useState(null),[f,g]=l.useState(null),[x,b]=l.useState(""),D=n===void 0,t=n?.soul,k=n?.owner,o=n?.latestVersion,E=c(a.souls.listVersions,t?{soulId:t._id,limit:50}:"skip"),y=c(a.soulStars.isStarred,i&&t?{soulId:t._id}:"skip"),w=c(a.soulComments.listBySoul,t?{soulId:t._id,limit:50}:"skip"),L=l.useMemo(()=>u?B(u):null,[u]);if(l.useEffect(()=>{S.current||(S.current=!0,p({}))},[p]),l.useEffect(()=>{if(!o)return;h(null),g(null);let e=!1;return N({versionId:o._id}).then(r=>{e||h(r.text)}).catch(r=>{e||(g(r instanceof Error?r.message:"Failed to load SOUL.md"),h(null))}),()=>{e=!0}},[o,N]),D)return s.jsx("main",{className:"section",children:s.jsx("div",{className:"card",children:s.jsx("div",{className:"loading-indicator",children:"Loading soul…"})})});if(n===null||!t)return s.jsx("main",{className:"section",children:s.jsx("div",{className:"card",children:"Soul not found."})});const v=k?.handle??k?.name??null,C=`https://wry-manatee-359.convex.site/api/v1/souls/${t.slug}/file`;return s.jsx("main",{className:"section",children:s.jsxs("div",{className:"skill-detail-stack",children:[s.jsx("div",{className:"card skill-hero",children:s.jsxs("div",{className:"skill-hero-header",children:[s.jsxs("div",{className:"skill-hero-title",children:[s.jsx("h1",{className:"section-title",style:{margin:0},children:t.displayName}),s.jsx("p",{className:"section-subtitle",children:t.summary??"No summary provided."}),s.jsx("div",{className:"stat",children:s.jsx(A,{stats:t.stats,versionSuffix:"versions"})}),v?s.jsxs("div",{className:"stat",children:["by ",s.jsxs("a",{href:`/u/${v}`,children:["@",v]})]}):null,s.jsx("div",{className:"skill-actions",children:i?s.jsx("button",{className:`star-toggle${y?" is-active":""}`,type:"button",onClick:()=>{_({soulId:t._id})},"aria-label":y?"Unstar soul":"Star soul",children:s.jsx("span",{"aria-hidden":"true",children:"★"})}):null})]}),s.jsxs("div",{className:"skill-hero-cta",children:[s.jsxs("div",{className:"skill-version-pill",children:[s.jsx("span",{className:"skill-version-label",children:"Current version"}),s.jsxs("strong",{children:["v",o?.version??"—"]})]}),s.jsx("a",{className:"btn btn-primary",href:`${C}?path=SOUL.md`,"aria-label":"Download SOUL.md",children:"Download SOUL.md"})]})]})}),s.jsx("div",{className:"card",children:s.jsx("div",{className:"skill-readme markdown",children:L?s.jsx(P,{remarkPlugins:[V],children:L}):f?s.jsxs("div",{className:"stat",children:["Failed to load SOUL.md: ",f]}):s.jsx("div",{className:"loading-indicator",children:"Loading SOUL.md…"})})}),s.jsxs("div",{className:"card",children:[s.jsx("h2",{className:"section-title",style:{fontSize:"1.2rem",marginBottom:8},children:"Versions"}),s.jsx("div",{className:"version-scroll",children:s.jsx("div",{className:"version-list",children:(E??[]).map(e=>s.jsxs("div",{className:"version-row",children:[s.jsxs("div",{className:"version-info",children:[s.jsxs("div",{children:["v",e.version," · ",new Date(e.createdAt).toLocaleDateString(),e.changelogSource==="auto"?s.jsx("span",{style:{color:"var(--ink-soft)"},children:" · auto"}):null]}),s.jsx("div",{style:{color:"#5c554e",whiteSpace:"pre-wrap"},children:e.changelog})]}),s.jsx("div",{className:"version-actions",children:s.jsx("a",{className:"btn version-zip",href:`${C}?path=SOUL.md&version=${encodeURIComponent(e.version)}`,children:"SOUL.md"})})]},e._id))})})]}),s.jsxs("div",{className:"card",children:[s.jsx("h2",{className:"section-title",style:{fontSize:"1.2rem",margin:0},children:"Comments"}),i?s.jsxs("form",{onSubmit:e=>{e.preventDefault(),x.trim()&&I({soulId:t._id,body:x.trim()}).then(()=>b(""))},className:"comment-form",children:[s.jsx("textarea",{className:"comment-input",rows:4,value:x,onChange:e=>b(e.target.value),placeholder:"Leave a note…"}),s.jsx("button",{className:"btn comment-submit",type:"submit",children:"Post comment"})]}):s.jsx("p",{className:"section-subtitle",children:"Sign in to comment."}),s.jsx("div",{style:{display:"grid",gap:12,marginTop:16},children:(w??[]).length===0?s.jsx("div",{className:"stat",children:"No comments yet."}):(w??[]).map(e=>s.jsxs("div",{className:"comment-item",children:[s.jsxs("div",{className:"comment-body",children:[s.jsxs("strong",{children:["@",e.user?.handle??e.user?.name??"user"]}),s.jsx("div",{className:"comment-body-text",children:e.comment.body})]}),i&&m&&(m._id===e.comment.userId||$(m))?s.jsx("button",{className:"btn comment-delete",type:"button",onClick:()=>{R({commentId:e.comment._id})},children:"Delete"}):null]},e.comment._id))})]})]})})}function Q(){const{slug:d}=M.useParams();return s.jsx(z,{slug:d})}export{Q as component};
